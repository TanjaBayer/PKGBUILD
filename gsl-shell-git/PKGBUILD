# Maintainer: Benjamin Chretien (chretien at lirmm dot fr)
# Contributor: DevRandom (jruffin at gmail dot com)
# Contributor: perlawk
pkgname=gsl-shell-git
pkgver=20130529
pkgver() {
    date +%Y%m%d
}
pkgrel=1
pkgdesc="Offers an interactive Lua scripting interface to the GSL collection of mathematical functions. Git version." 
url="http://www.nongnu.org/gsl-shell/"
arch=('i686' 'x86_64')
license=('GPLv3')
depends=('gsl' 'agg' 'fox' 'freetype2')
makedepends=('git')
provides=('gsl-shell')
conflicts=('gsl-shell')
optdepends=("openblas: improve the speed for operation on large matrices"
            "atlas-lapack: improve the speed for operation on large matrices")
source=("truetype.patch" "cblas.patch")
md5sums=('f8f6d563d1901e53638efa854c16e54f'
         '686c44873fffcd9059f27d66cb0564a9')

_gitroot="git://github.com/franko/gsl-shell.git"
_gitname="gsl-shell"

build() {
    msg "Connecting to Git server"

    if [ -d ${srcdir}/${_gitname} ] ; then
        # Update local files (including submodules)
        cd ${srcdir}/${_gitname} && git pull origin master || return 1
        msg "The local files are updated."
    else
        # Clone repository and submodules
        git clone --depth 1 ${_gitroot} ${srcdir}/${_gitname} || return 1
    fi

    cd "$srcdir/$_gitname"

    msg "Patching agg-plot/support_x11.cpp for truetype fonts support"
    patch -p1 < ../truetype.patch
    msg "Patching makepackages to fix linking error"
    patch -p1 < ../cblas.patch

    msg "Configuring installation"
    sed -i -e "s|PREFIX=.*$|PREFIX=/usr|" makeconfig
    sed -i -e "s|DESTDIR=.*$|DESTDIR=$pkgdir|" makeconfig

    # The library dependencies are not handled too well in the Makefile.
    # Building the package with -j8 in the make options tends failing
    # because LuaJIT2 and libagg get linked before they are built.
    # We work around this by building them explicitly before the rest.
    msg "Building gsl-shell"
    make -j1 luajit2 && make -j1 agg-plot && make
}
package() {
    cd "$srcdir/gsl-shell"
    make install
}
